# Skeleton Analyzer 사용법

> 📅 마지막 갱신: 2026-02-21

## 설치

### 1. 저장소 클론

```bash
git clone https://github.com/swish1995/Safety_Doc.git
cd Safety_Doc
git checkout skeleton-analyzer
cd skeleton-analyzer
```

### 2. 가상환경 설정

```bash
# 가상환경 생성
python -m venv venv

# 활성화 (macOS/Linux)
source venv/bin/activate

# 활성화 (Windows)
venv\Scripts\activate
```

### 3. 의존성 설치

```bash
pip install -r requirements.txt
```

### 4. 실행

```bash
python main.py
```

## 라이센스

Skeleton Analyzer는 **무료 버전**과 **등록 버전**으로 제공됩니다.

### 무료 기능

- 동영상 로드 및 재생
- 실시간 스켈레톤 추출
- 관절 각도 계산
- RULA 평가
- REBA 평가
- OWAS 평가
- 프레임 캡처
- 이미지 폴더 로드 및 슬라이드쇼
- 압축 파일(ZIP) 이미지 로드

### 등록 기능 (🔑)

- NLE 평가 (NIOSH 들기 작업)
- SI 평가 (반복 작업 스트레인)
- 프로젝트 저장/열기
- Excel 내보내기
- JSON 내보내기
- 스켈레톤 편집 (관절 드래그로 점수 재계산)

### 라이센스 등록 방법

1. `도움말` → `라이센스 등록` 메뉴 선택
2. **하드웨어 ID**를 복사하여 관리자에게 전달
3. 발급받은 라이센스 키 입력 후 등록

> 라이센스 키는 하드웨어에 종속됩니다. 컴퓨터 변경 시 새 키가 필요합니다.

## 사용 방법

### 동영상 열기

1. **메뉴**: 파일 → 동영상 파일 열기 (Ctrl+O)
2. **버튼**: "파일 열기" 버튼 클릭
3. **드래그 앤 드롭**: 동영상 파일을 창에 드롭

### 이미지 슬라이드쇼

이미지 폴더 또는 압축 파일을 로드하여 슬라이드쇼 형태로 사용할 수 있습니다.

#### 이미지 폴더 열기
1. **메뉴**: 파일 → 이미지 폴더 열기
2. **버튼**: PlayerWidget 상단의 "이미지 폴더" 버튼 클릭
3. 지원 형식: JPG, JPEG, PNG, BMP, TIFF

#### 압축 파일 열기
1. **메뉴**: 파일 → 압축 파일 열기
2. **버튼**: PlayerWidget 상단의 "압축 파일" 버튼 클릭
3. ZIP 파일 내 이미지 파일을 자동 추출하여 로드

#### 이미지 네비게이션

| 동작 | 방법 |
|------|------|
| 이전 이미지 | ← 화살표 또는 ◀ 버튼 |
| 다음 이미지 | → 화살표 또는 ▶ 버튼 |
| 특정 이미지로 이동 | 슬라이더 드래그 |
| **캡처** | **Enter** |

### 프로젝트 관리 (🔑 등록 기능)

> **참고**: 프로젝트 저장/열기 기능은 라이센스 등록이 필요합니다.

1. **작업 불러오기**: 파일 → 작업 불러오기 (Ctrl+Shift+O)
2. **작업 저장**: 파일 → 작업 저장 (Ctrl+S)
3. **다른 이름으로 저장**: 파일 → 다른 이름으로 저장 (Ctrl+Shift+S)

### 지원 형식

- MP4 (.mp4)
- AVI (.avi)
- MOV (.mov)
- MKV (.mkv)
- 프로젝트 파일 (.skpx)
- 이미지 폴더 (JPG, JPEG, PNG, BMP, TIFF)
- 압축 파일 (.zip)

### 재생 컨트롤

| 동작 | 방법 |
|------|------|
| 재생/일시정지 | Space 또는 ▶/⏸ 버튼 |
| 정지 | ■ 버튼 |
| 5초 뒤로 | ← 화살표 (이미지 모드: 이전 이미지) |
| 5초 앞으로 | → 화살표 (이미지 모드: 다음 이미지) |
| 위치 이동 | 시크바 드래그 |
| **캡처** | **Enter** |

## 화면 구성

```
┌───────────────────────────────────────────────────────────────────────────────┐
│ [작업 불러오기][작업 저장] | 보기: [상태(⌘1)][데이터(⌘2)] | [안전지표(⌘3)][RULA][REBA][OWAS]│
├─────────────────────────────┬─────────────────────────────────────────────────┤
│                             │  ┌──────────────────┬──────────────────┐       │
│                             │  │  스켈레톤 시각화  │   관절 각도 정보  │       │
│       동영상 재생            │  └──────────────────┴──────────────────┘       │
│                             │  ┌────────────┬────────────┬────────────┐       │
│                             │  │    RULA    │    REBA    │    OWAS    │       │
│                             │  │  (안전지표 패널)                      │       │
│                             │  └────────────┴────────────┴────────────┘       │
│                             │  ┌─────────────────────────────────────┐       │
│                             │  │       캡처 데이터 스프레드시트        │       │
│                             │  └─────────────────────────────────────┘       │
├─────────────────────────────┴─────────────────────────────────────────────────┤
│  [▶] [⏸] [■]  00:00 ══════════════════════════════ 05:30    [캡처]           │
└───────────────────────────────────────────────────────────────────────────────┘
```

### 왼쪽 패널: 동영상 플레이어
- 원본 동영상 재생
- 재생 컨트롤 (재생/일시정지/정지)
- 시크바 및 시간 표시

### 오른쪽 상단: 상태 패널
- **스켈레톤 시각화**: 감지된 인체 스켈레톤 표시 (33개 랜드마크)
- **관절 각도**: 13개 주요 관절 각도 실시간 표시

### 오른쪽 중단: 안전지표 패널 (RULA/REBA/OWAS)

#### RULA 표시 항목
- 최종 점수 (1-7)
- 위험 수준 (허용 가능 / 추가 조사 필요 / 빠른 개선 필요 / 즉시 개선 필요)
- A그룹 점수 (상지)
- B그룹 점수 (목/몸통)
- 부위별 점수 (상완, 전완, 손목, 손목비틀림, 목, 몸통, 다리)

#### REBA 표시 항목
- 최종 점수 (1-12)
- 위험 수준 (무시 가능 / 낮음 / 중간 / 높음 / 매우 높음)
- A그룹 점수 (목/몸통/다리)
- B그룹 점수 (상지)
- 부위별 점수 (목, 몸통, 다리, 상완, 전완, 손목)

#### OWAS 표시 항목
- 4자리 자세 코드 (등/팔/다리/하중)
- 조치 카테고리 (AC1-AC4)
- 위험 수준 (정상 / 약간 유해 / 명백히 유해 / 매우 유해)
- 각 코드별 자세 설명

### 오른쪽 하단: 데이터 패널
- 캡처된 모든 데이터 스프레드시트 표시
- 썸네일, 타임스탬프, RULA/REBA/OWAS 점수 포함

## 보기 옵션

툴바 버튼 또는 단축키로 패널을 토글할 수 있습니다:

| 단축키 | 패널 | 설명 |
|--------|------|------|
| Ctrl+1 | 상태 | 스켈레톤 + 각도 표시 |
| Ctrl+2 | 데이터 | 캡처 스프레드시트 |
| Ctrl+3 | 안전지표 | RULA/REBA/OWAS 평가 결과 |

개별 안전지표(RULA, REBA, OWAS)는 툴바의 개별 버튼으로 토글할 수 있습니다.

> macOS에서는 `Ctrl` 대신 `Cmd(⌘)` 사용

## 캡처 기능

1. 원하는 시점에서 `Enter` 키를 누르거나 캡처 버튼 클릭
2. 현재 상태(타임스탬프, 프레임, 모든 평가 점수)가 스프레드시트에 저장
3. 썸네일 이미지도 함께 저장

## 스켈레톤 편집 (🔑 등록 기능)

관절 좌표를 직접 드래그하여 이동하면 RULA/REBA/OWAS 점수가 실시간으로 재계산됩니다.

### 사용 방법

1. 동영상을 로드하고 인체가 감지된 프레임에서 일시정지
2. 스켈레톤 시각화 패널에서 관절점을 **클릭** → 자동으로 편집 모드 진입, 영상 일시정지
3. 관절을 드래그하여 이동 → 우측 각도/점수 실시간 재계산
4. 동영상을 다시 **재생**하면 편집 모드 자동 해제

### 마우스 조작

| 동작 | 방법 |
|------|------|
| 관절 이동 (편집 자동 시작) | 관절을 좌클릭 드래그 |
| 화면 이동 (팬) | 편집 모드에서 빈 영역 좌클릭 드래그 |
| 확대/축소 | 편집 모드에서 마우스 휠 또는 +/- 버튼 |

### 컨트롤 바

| 버튼 | 설명 |
|------|------|
| 초기화 | 관절 위치를 편집 전으로 복원 + 확대/축소/이동 초기화 |
| +/- | 확대/축소 |

### 편집 가능 관절 (13개)

- **상체**: 코, 왼쪽/오른쪽 어깨, 팔꿈치, 손목
- **하체**: 왼쪽/오른쪽 고관절, 무릎, 발목

> 동영상을 재생하면 자동으로 편집 모드가 해제되고 영상 기반 실시간 분석으로 돌아갑니다.

## 위험 수준 색상

모든 평가 방법에서 동일한 색상 체계를 사용합니다:

| 색상 | 의미 |
|------|------|
| 🟢 초록 | 안전 / 정상 |
| 🟡 노랑 | 주의 / 조사 필요 |
| 🟠 주황 | 경고 / 개선 필요 |
| 🔴 빨강 | 위험 / 즉시 개선 |

## 감지되는 관절

| 관절 | 설명 |
|------|------|
| 목 (Neck) | 머리-목-척추 각도 |
| 왼쪽 어깨 | 팔꿈치-어깨-골반 |
| 오른쪽 어깨 | 팔꿈치-어깨-골반 |
| 왼쪽 팔꿈치 | 어깨-팔꿈치-손목 |
| 오른쪽 팔꿈치 | 어깨-팔꿈치-손목 |
| 왼쪽 손목 | 팔꿈치-손목-손 |
| 오른쪽 손목 | 팔꿈치-손목-손 |
| 왼쪽 골반 | 어깨-골반-무릎 |
| 오른쪽 골반 | 어깨-골반-무릎 |
| 왼쪽 무릎 | 골반-무릎-발목 |
| 오른쪽 무릎 | 골반-무릎-발목 |

## 문제 해결

### MediaPipe 모델 다운로드 오류

```bash
# 수동 다운로드
wget https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/1/pose_landmarker_lite.task
mv pose_landmarker_lite.task src/core/pose_landmarker.task
```

### PyQt6 설치 오류 (macOS)

```bash
pip install --upgrade pip
pip install PyQt6 --force-reinstall
```

### 영상 재생 안 됨

- 코덱 문제: FFmpeg 설치 필요
- 파일 손상: 다른 플레이어에서 재생 확인

## 개발자 가이드

### 테스트 실행

```bash
pytest tests/ -v
```

### 커버리지 확인

```bash
pytest tests/ --cov=src --cov-report=html
```

### 패키징

```bash
pyinstaller skeleton_analyzer.spec
# 결과: dist/skeleton_analyzer.app (macOS) 또는 dist/skeleton_analyzer.exe (Windows)
```
