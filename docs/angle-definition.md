# 인체 각도 정의

MediaPipe Pose Landmarker가 감지한 33개 랜드마크를 사용하여 굴곡 각도를 계산한다.
모든 굴곡 각도는 **0° = 자연 자세(펴짐/직립)** 기준이며, 값이 클수록 굴곡이 크다.

## 측정 원칙

### 2D 계산

모든 굴곡 각도는 **2D(x, y) 좌표만** 사용하여 계산한다.
MediaPipe의 z좌표(깊이)는 정면 카메라에서 노이즈가 크고, 코 끝 등 돌출 랜드마크의
전방 편향을 유발하여 과대 측정의 원인이 된다.

### 감지 민감도 시스템

위치 감지 및 각도 점수 임계값은 `base_assessment.py`의 `DEFAULT_DETECTION_THRESHOLDS`에 정의되며,
`detection_sensitivity` 변수로 일괄 조정 가능하다.

```python
# 실제 적용값 = 기본값 × detection_sensitivity
# detection_sensitivity: 1.0=기본, >1.0=둔감, <1.0=민감
```

| 키 | 기본값 | 설명 |
|----|--------|------|
| `neck_twisted` | 0.08 | 목 회전 감지 (귀중심-어깨중심 x좌표 차이) |
| `trunk_side_bending` | 0.05 | 몸통 측굴 감지 (좌우 어깨 y좌표 차이) |
| `upper_arm_abducted` | 0.06 | 상박 외전 감지 (팔꿈치-어깨 x좌표 차이) |
| `neck_flexion_mid` | 15° | 목 1→2점 경계 (RULA 표준: 10°) |
| `neck_flexion_high` | 35° | 목 2→3점 경계 (RULA 표준: 20°) |
| `elbow_flexion_low` | 0° | 하박 1점 하한 (RULA 표준: 60°) |
| `elbow_flexion_high` | 110° | 하박 1점 상한 (RULA 표준: 100°) |

> 표준값과 다른 이유: 2D 정면 카메라에서의 과대/과소 측정을 보정하기 위함

---

## 1. 목 (Neck Flexion)

### 측정 방법

**귀 중심점** → 어깨 중심 → 엉덩이 중심의 3점 각도(2D)를 이용하여
`180° - 각도 - 보정값`으로 목 굴곡을 계산한다.

```
        귀중심
       ╱
      ╱ ← 180° - 이 각도 - 5° = 목 굴곡
     ╱
  어깨중심
     |
  엉덩이중심
```

- nose 대신 **귀 중심점**(left_ear + right_ear 중간) 사용
  - 코 끝은 얼굴 방향에 따라 x좌표가 크게 변해 편향 발생
  - 귀 중심점은 두개골 중심에 가까워 안정적
- **NECK_OFFSET = 5°** 보정값 차감 (정면 카메라 잔여 편향 보정)

### 사용 랜드마크

| 랜드마크 | 역할 |
|---------|------|
| `left_ear` (7) | 귀 중심점 계산 |
| `right_ear` (8) | 귀 중심점 계산 |
| `left_shoulder` (11) | 어깨 중심 계산 |
| `right_shoulder` (12) | 어깨 중심 계산 |
| `left_hip` (23) | 엉덩이 중심 계산 |
| `right_hip` (24) | 엉덩이 중심 계산 |

### 계산 로직

```python
NECK_OFFSET = 5.0
ear_center_2d = ((left_ear.x + right_ear.x) / 2, (left_ear.y + right_ear.y) / 2)
sc_2d = (shoulder_center.x, shoulder_center.y)
hc_2d = (hip_center.x, hip_center.y)
neck_trunk_angle = calculate_angle(ear_center_2d, sc_2d, hc_2d)
neck_flexion = max(180 - neck_trunk_angle - NECK_OFFSET, 0)
```

### 추가 판정 (회전)

귀 중심점과 어깨 중심의 x좌표 차이로 판정한다 (nose가 아닌 귀 사용).

| 판정 | 조건 | 가점 |
|------|------|------|
| 회전 | `abs(ear_center.x - shoulder_center.x) > 0.08` | +1 |

### RULA 점수 (임계값 보정 적용)

| base 점수 | 조건 |
|-----------|------|
| 1 | 굴곡 0~15° |
| 2 | 굴곡 15~35° |
| 3 | 굴곡 >35° |

### REBA 점수

| base 점수 | 조건 |
|-----------|------|
| 1 | 굴곡 0~35° |
| 2 | 굴곡 >35° |

---

## 2. 몸통 (Trunk Flexion)

### 측정 방법

어깨 중심에서 엉덩이 중심 방향이 **수직선과 이루는 각도**를 몸통 굴곡으로 정의한다.

```python
trunk_flexion = atan(|dx| / |dy|)  # 0°=수직, 90°=수평
```

### RULA / REBA 점수

| base 점수 | 조건 |
|-----------|------|
| 1 | 굴곡 ≤5° |
| 2 | 굴곡 5~20° |
| 3 | 굴곡 20~60° |
| 4 | 굴곡 >60° |

### 추가 판정

| 판정 | 조건 | 가점 |
|------|------|------|
| 측굴 | `abs(left_shoulder.y - right_shoulder.y) > 0.05` | +1 |

---

## 3. 상박 (Shoulder Flexion)

### 측정 방법

어깨를 꼭짓점으로 **팔꿈치 방향**과 **엉덩이 방향** 사이의 2D 각도를 측정한다.
팔을 내린 상태에서 0°이며, 팔을 올릴수록 각도가 증가한다.

```python
left_shoulder_flexion = calculate_angle(elbow_2d, shoulder_2d, hip_2d)
```

| 자세 | 각도 |
|------|------|
| 팔 자연스럽게 내림 | 0~20° |
| 팔 45° 거상 | ~45° |
| 팔 수평 | ~90° |

### RULA / REBA 점수

| base 점수 | 조건 |
|-----------|------|
| 1 | 굴곡 -20°~20° |
| 2 | 굴곡 20~45° |
| 3 | 굴곡 45~90° |
| 4 | 굴곡 >90° |

### 추가 판정

| 판정 | 조건 | 가점 |
|------|------|------|
| 외전 | `elbow.x < shoulder.x - 0.06` | +1 |
| 어깨 올림 | 미구현 | +1 |
| 팔 지지 | 미구현 | -1 |

---

## 4. 하박 (Elbow Flexion)

### 측정 방법

`180° - calculate_angle(shoulder_2d, elbow_2d, wrist_2d)`로 팔꿈치 굴곡을 계산한다.
팔을 완전히 편 상태가 0°이며, 구부릴수록 값이 증가한다.

| 자세 | 굴곡 |
|------|------|
| 팔 완전히 편 상태 | 0° |
| 직각 구부림 | ~90° |
| 최대 구부림 | ~140° |

### RULA / REBA 점수 (임계값 보정 적용)

| base 점수 | 조건 |
|-----------|------|
| 1 | 굴곡 0~110° |
| 2 | 굴곡 >110° |

> RULA 표준은 60~100°가 1점이지만, 2D 정면 카메라에서 팔꿈치 굴곡이 과소 측정되므로 하한을 0°로 보정

---

## 5. 손목 (Wrist Flexion)

### 측정 방법

검지/소지 두 방향의 각도 중 **더 큰 값**(= 최소 굴곡)을 기준으로 `180° - 각도`를 계산한다.

```python
left_wrist_max = max(
    calculate_angle(elbow_2d, wrist_2d, index_2d),
    calculate_angle(elbow_2d, wrist_2d, pinky_2d),
)
left_wrist_flexion = max(180 - left_wrist_max, 0)
```

| 자세 | 굴곡 |
|------|------|
| 중립 (곧은 상태) | 0° |
| 약간 꺾임 | 5~15° |
| 많이 꺾임 | >15° |

### RULA 점수

| base 점수 | 조건 |
|-----------|------|
| 1 | 굴곡 ≤5° |
| 2 | 굴곡 5~15° |
| 3 | 굴곡 >15° |

### REBA 점수

| base 점수 | 조건 |
|-----------|------|
| 1 | 굴곡 ≤15° |
| 2 | 굴곡 >15° |

### 손목 비틀림

카메라로 손목 회전을 측정할 수 없으므로 기본값 1을 사용한다 (RULA 1-2 범위).

---

## 6. 무릎 (Knee Flexion)

### 측정 방법

`180° - calculate_angle(hip_2d, knee_2d, ankle_2d)`로 무릎 굴곡을 계산한다.
다리를 편 상태가 0°이며, 구부릴수록 값이 증가한다.

| 자세 | 굴곡 |
|------|------|
| 다리 편 상태 | 0~10° |
| 약간 구부림 | 10~30° |
| 상당히 구부림 | 30~60° |
| 쪼그려 앉기 | >90° |

### RULA 점수

| base 점수 | 조건 |
|-----------|------|
| 1 | 양쪽 무릎 굴곡 ≤20° (서 있음) |
| 2 | 한쪽이라도 >20° |

### REBA 점수

| 가점 | 조건 |
|------|------|
| +0 | 굴곡 ≤30° |
| +1 | 굴곡 30~60° |
| +2 | 굴곡 >60° |

---

## 제한사항

- **2D 정면 카메라 한계**: 전후 방향(앞뒤로 움직임)은 감지가 제한적
- **z축 미사용**: MediaPipe z좌표의 노이즈와 돌출 랜드마크 편향으로 인해 모든 굴곡 각도에서 z축 제외
- **좌측 기준 평가**: RULA/REBA 점수는 현재 왼쪽 팔 기준으로 계산 (우측은 표시만)
- **미구현 항목**: 어깨 올림, 팔 지지, 손목 비틀림, 손목 측면 꺾임은 카메라로 감지 불가하여 미구현 또는 기본값 사용
